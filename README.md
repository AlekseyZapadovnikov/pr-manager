
# PR Manager

## Содержание

- [Описание проекта](#описание-проекта)
- [Ключевые возможности](#ключевые-возможности)
- [Быстрый старт (Docker Compose)](#быстрый-старт-docker-compose)
- [Архитектура проекта](#архитектура-проекта)
- [Тестирование](#тестирование)
- [Запуск тестов](#запуск-тестов)

## Описание проекта

PR Manager — это сервис для управления pull requests, пользователями и командами, написанный на Go. Сервис предоставляет REST API для создания, слияния и переназначения pull requests, а также для управления пользователями и командами разработки.

Система автоматически назначает ревьюверов из команды автора и обеспечивает гибкое управление процессом код-ревью.

## Ключевые возможности

- **Управление pull requests**: Создание, слияние и переназначение PR  
- **Управление пользователями**: Активация/деактивация пользователей, отслеживание назначенных PR  
- **Управление командами**: Создание команд с участниками, массовая деактивация  
- **Автоматическое назначение ревьюверов**: До 2 активных участников команды автора  
- **Статистика и отчетность**: Агрегированная статистика по назначениям  
- **Безопасная замена ревьюверов**: Автоматическое переназначение PR при деактивации  
- **REST API**: Полнофункциональный API с обработкой ошибок  
- **Веб-интерфейс**: Статический фронтенд для базовой навигации  

## Быстрый старт (Docker Compose)

1. Создайте копию конфигурационного файла и настройте его:
   ```bash
   cp conf/config.example.json conf/config.json
   ```
   (Для PowerShell: `Copy-Item conf/config.example.json conf/config.json`)

2. Создайте локальный файл `.env` и установите пароль для PostgreSQL и приложения.
обратите внимание, .env файл должен быть сохранён в кодировке UTF-8:
   ```bash
   echo PR_MANAGER_DB_PASSWORD=yourStrongPassword > .env
   ```

3. Запустите стек:
   ```bash
   docker compose up --build
   ```

4. Остановите всё после завершения работы:
   ```bash
   docker compose down -v
   ```

Docker Compose автоматически загружает `.env`, создаёт БД и запускает миграции.

## Архитектура проекта

Проект следует паттерну чистой архитектуры с четким разделением на 3 слоя:  
**Представление → Бизнес-логика → Репозиторий**.  
Сущности сделаны глобальными и находятся в пакете `models`.

### Структура приложения

```
cmd/                    # Точка входа в приложение
conf/                   # Управление конфигурацией
internal/
├── domain/            # Обработка ошибок и доменная логика
├── models/            # Доменные модели
├── repository/        # Слой доступа к данным (PostgreSQL)
├── service/           # Бизнес-логика
└── web/               # HTTP обработчики и сервер
migrations/            # Миграции базы данных PostgreSQL
tests/                 # тестирование E2E, нагрузочное
```

### Основные компоненты

- **Сервер**: HTTP-сервер на chi/v5 с middleware  
- **Бизнес-логика**: Сервисы `PullRequestManager` и `UserManager`  
- **База данных**: PostgreSQL с драйвером pgx/v5  
- **Конфигурация**: JSON с переопределением через переменные окружения  

### Схема базы данных

- **teams**: Определения команд  
- **users**: Профили пользователей со статусом активности  
- **pull_requests**: Основные данные PR с автором и статусами  
- **pull_request_reviewers**: Связь PR и ревьюверов (0–2 на PR)  

## Тестирование

Проект покрыт тестами на **82.3%** (по данным `go test -cover`, не учитывая код из директории ./tests),
если учитывать директорию tests то покрытие 61.7%, но помимо unit тестов реализовано
  
- **E2E-тесты** — сквозные сценарии через HTTP API с использованием реальной БД в контейнере  
- **Нагрузочное тестирование** — проверка производительности и стабильности под нагрузкой  

Все тесты находятся в директории [`tests/`](tests/).

### Результаты нагрузочного тестирования

Нагрузка: **5 RPS в течение 30 секунд**

```text
Load test summary:
  Target RPS: 5.00, Actual RPS: 4.99
  Requests: 150 total, 150 succeeded, 0 failed
  Bulk deactivate latency avg: 7.23 ms, p95: 13.42 ms, max: 95.61 ms
  Reassignment latency avg: 7.23 ms, p95: 13.42 ms, max: 95.61 ms
```

Сервис стабильно обрабатывает целевую нагрузку без ошибок. Медианная задержка — менее 10 мс, 95-й перцентиль — около 13 мс. Это удовлетворяет ТЗ.

## Запуск тестов

### Требования

- Go 1.24.2+  
- golangci-lint (для линтинга)

### Команды

```bash
# Запустить все тесты
make test
# или
go test ./...

# Запустить тесты с покрытием
make cover

# Сгенерировать HTML отчет покрытия
make cover-html

# Запустить E2E и нагрузочные тесты (требуется запущенная БД)
cd tests && go test -tags=e2e ./...

# Отформатировать код
make fmt

# Запустить статический анализ
make lint

# Установить зависимости
make tidy

# Очистить артефакты
make clean
```

### Локальная разработка

Для локальной разработки без Docker:

```bash
# Собрать приложение
go build -o pr-manager ./cmd/main.go

# Запустить с конфигурацией по умолчанию
CONFIG_PATH=conf/config.json ./pr-manager
```

### Тестирование API

Сервис предоставляет следующие основные эндпоинты:

- **Команды**: `POST /team/add`, `GET /team/get`, `POST /team/deactivateUsers`  
- **Пользователи**: `POST /users/setIsActive`, `GET /users/getReview`  
- **Pull Requests**: `POST /pullRequest/create`, `POST /pullRequest/merge`, `POST /pullRequest/reassign`  
- **Система**: `GET /health`, `GET /stats/assignments`  

Подробная спецификация API доступна в файле [openapi.yml](openapi.yml).
